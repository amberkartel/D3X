<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D3X VERCEL - Dashboard (USD â€¢ Paystack)</title>
  <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body style="background:#0b0e17;color:#fff;font-family:Arial,sans-serif">
  <h1>D3X VERCEL</h1>
  <p>Wallet ID: <span id="wallet-id"></span></p>

  <input type="number" id="buy-usd" placeholder="Enter USD amount" />
  <select id="buy-coin">
    <option value="BTC">Bitcoin</option>
    <option value="ETH">Ethereum</option>
    <option value="USDT">Tether</option>
  </select>
  <button onclick="payWithPaystack()">Pay with Paystack</button>

  <script>
    function generateWalletId(){ return "D3X-" + Math.random().toString(36).substring(2,10).toUpperCase(); }
    let walletId = localStorage.getItem("walletId");
    if(!walletId){ walletId = generateWalletId(); localStorage.setItem("walletId", walletId); }
    document.getElementById("wallet-id").textContent = walletId;

    const rateMap = { BTC: 65000, ETH: 2800, USDT: 1 };
    let balances = JSON.parse(localStorage.getItem("balances")) || { USD:0, BTC:0, ETH:0, USDT:0 };

    function payWithPaystack(){
      const usd = parseFloat(document.getElementById("buy-usd").value);
      const coin = document.getElementById("buy-coin").value;
      if(!usd || usd <= 0){ alert("Enter amount"); return; }

      var handler = PaystackPop.setup({
        key: 'pk_live_b74b2d92842a32feda36c2d4cd98dc50d2944c12',  // LIVE public key
        email: 'customer@example.com',
        amount: Math.round(usd * 100),  // amount in kobo (USD*100 for cents)
        currency: 'USD',
        ref: walletId + '-' + Date.now(),
        metadata: { custom_fields: [{ display_name:'Wallet ID', variable_name:'wallet_id', value:walletId }] },
        callback: function(response){
          fetch('/api/verify-payment?reference='+encodeURIComponent(response.reference))
            .then(r=>r.json())
            .then(data=>{
              if(data.status==='success'){
                const qty = usd / rateMap[coin];
                balances[coin]+=qty;
                localStorage.setItem("balances", JSON.stringify(balances));
                alert('Payment verified! Ref: '+response.reference);
              }else{
                alert('Payment verification failed');
              }
            }).catch(err=>alert('Server error'));
        },
        onClose:function(){ alert('Transaction cancelled'); }
      });
      handler.openIframe();
    }
  </script>
</body>
</html>